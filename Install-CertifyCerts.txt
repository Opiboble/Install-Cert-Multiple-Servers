#Load functions needed

#Creates Secure Credentials for Storing
Function Get-Credentials {
    Param (
	[String]$AuthUser = $env:USERNAME,
    [string]$PathToCred = "c:\data\scripts"
    )
    $Key = [byte]20,35,18,74,72,75,85,50,71,44,0,21,98,73,98,28
	
	#Check if folder exists/build folder
	Folder-checkandcreate -path $PathToCred
	
    #Build the path to the credential file
    $CredFile = $AuthUser.Replace("\","~")
    $File = $PathToCred + "\Credentials-$CredFile.crd"
    #And find out if it's there, if not create it
    If (-not (Test-Path $File))
    {	(Get-Credential $AuthUser).Password | ConvertFrom-SecureString -Key $Key | Set-Content $File
    }
	
    #Load the credential file 
    $Password = Get-Content $File | ConvertTo-SecureString -Key $Key
    $AuthUser = (Split-Path $File -Leaf).Substring(12).Replace("~","\")
    $AuthUser = $AuthUser.Substring(0,$AuthUser.Length - 4)
    $Credential = New-Object System.Management.Automation.PsCredential($AuthUser,$Password)
    Return $Credential
}

#Check/build needed input path

Function Folder-checkandcreate {
	Param (
	[String]$Path = "c:\data"
	)

		If(!(test-path $path))
		{
			New-Item -ItemType Directory -Force -Path $path
		}
}


#Servers
$Certify = "rn-exchange"
$Exchange = "rn-exchange"

#Account
$Account = "reece\rnadmin"

#Credentials
$Cred = Get-Credentials -AuthUser $Account


#Pull cert from Certify Server
$s = New-PSSession -ComputerName $Certify -Credential $Cred

Invoke-Command $s -ScriptBlock {Get-ChildItem -Path cert:\LocalMachine\My\7D27C05C26629947362C5BD809C45E12548A4966 | Export-PfxCertificate -FilePath c:\data\mypfx.pfx -ProtectTo $Account }

#Exports to \\$Certify\c$\data\mypfx.pfx

